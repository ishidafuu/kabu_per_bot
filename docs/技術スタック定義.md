# 技術スタック定義（MVP）

## 1. 結論

- 現時点の採用方針は `Firebase/GCP + Gemini + X API` とする。
- 用語は `ClaudeFunction` ではなく、実行基盤は `Cloud Functions for Firebase (2nd gen)`（Cloud Runベース）。
- `Grok` はMVP/第2段階初期では採用しない。X情報取得の不足が実測で確認された場合のみPoCで比較する。

## 2. 採用スタック（MVP）

### 2.1 アプリ/実行基盤

- 言語: Python 3.12
- 実行: Cloud Functions for Firebase (2nd gen)
- 理由:
  - スケジュール実行（決算通知、日次計算）を `onSchedule` で実装しやすい
  - サーバ管理不要で、MVPに必要なジョブ実行を早く作れる

### 2.2 データ/状態管理

- DB: Cloud Firestore
- 保存対象:
  - ウォッチリスト
  - 日次指標
  - 判定状態（streak含む）
  - 通知ログ
- 理由:
  - Firebaseとの統合が強く、初期実装を短期間で進めやすい
- スキーマ運用:
  - 初期マイグレーション: `scripts/migrate_firestore_v0001.py`
  - インデックス定義: `firestore.indexes.json`

### 2.3 スケジューラ

- Cloud Scheduler（Firebase Functionsの `onSchedule` 経由）
- ジョブ:
  - 日次計算ジョブ
  - 土曜21:00「来週決算」通知
  - 毎日21:00「明日決算」通知
- タイムゾーン: JST固定

### 2.4 通知

- 第一優先: Discord（Webhook）
- 第二優先: LINE Messaging API（Discord完成後）
- 理由:
  - MVPの最短到達を優先し、先にDiscordで通知経路を確立する

### 2.5 秘匿情報/設定

- Secret Manager:
  - Discord Webhook URL
  - LINEチャネルシークレット/トークン
  - データソース認証情報
- `.env` はローカル開発のみ利用し、本番はSecret Managerを正本とする

### 2.6 監視/運用

- Cloud Logging: 関数実行ログ・通知結果ログ
- Cloud Monitoring: 失敗回数、エラー率、ログベースアラート

## 3. SNS/AI（第2段階）

- 収集:
  - `X API` を使用して、公式アカウント/役員アカウントの投稿を取得する
- 分析:
  - `Vertex AI Gemini` で要約・分類・根拠抽出を行う
- 用途:
  - IR/SNS要約
  - 根拠URL・分類ラベル付きのAI注目通知
- Grokの扱い:
  - 初期実装では未採用
  - 次の条件を満たした場合のみ比較PoCを起票する
    - X API単独で必要な再現率/速報性を満たさない
    - 追加コスト（API二重運用）を許容できる

## 4. コスト方針（初期）

- 課金軸を以下の4系統で分離して監視する。
  - GCP基盤（Functions / Firestore / Scheduler / Logging）
  - LLM（Vertex AI Gemini）
  - SNS収集（X API）
  - 通知（Discord/LINEの外部API利用）
- コスト最適化の原則:
  - まず `X API + Gemini` の単一系統で運用
  - 同一投稿の再処理を避ける（投稿IDベースの重複除外）
  - 長文要約はバッチ化し、即時性が不要な処理を分離
- Grok導入判断:
  - 追加導入は「品質不足が定量で確認された場合のみ」
  - 導入時は必ず `Grok分の追加課金` と `運用複雑化` を比較する

## 5. 最小アーキテクチャ

1. Cloud Scheduler が定期トリガー
2. Cloud Functions がデータ取得・計算・判定
3. Firestore に状態保存（指標、判定、通知ログ）
4. Discordへ通知送信
5. 失敗時は Logging/Monitoring で検知

## 6. 実装順（この定義に基づく）

1. Issue 01: 初期構成・設定管理
2. Issue 02: Firestoreスキーマ/永続化層
3. Issue 03-11: 計算・判定・メッセージ整形
4. Issue 12: Discordボット/通知
5. Issue 14-15: 決算通知ジョブ
6. Issue 16-19: 欠損通知・ログ・テスト
7. Issue 13: LINE通知

## 7. Web管理画面（追加方針）

### 7.1 採用技術

- フロントエンド: React + TypeScript（Vite）
- フロント配信: Firebase Hosting
- API: FastAPI（Python）+ Cloud Run
- 認証: Firebase Authentication（IDトークン）
- API認可: FastAPI側で Firebase Admin SDK によるトークン検証

### 7.2 採用理由

- 既存の Python 実装（Issue 01〜03）を活かして API を構築できる
- FastAPI で OpenAPI スキーマを自動生成でき、画面連携を進めやすい
- Firebase Auth + Hosting + Firestore で GCP/Firebase 基盤を統一できる

### 7.3 運用原則

- ウォッチリストのビジネスルール（最大100件、入力検証）は API 側で強制する
- 画面は API の結果を表示するクライアントとし、ルールの正本は API とする
- 将来要件（権限分離、監査ログ）を見越し、直接 Firestore 書き込みを最小化する
