# 技術スタック定義（MVP）

## 1. 結論

- 想定は概ね正しい。
- 用語は `ClaudeFunction` ではなく、以下の組み合わせが正確。
  - 実行基盤: `Cloud Functions for Firebase (2nd gen)`（Cloud Runベース）
  - LLM: `Vertex AI の Anthropic Claude モデル`

## 2. 採用スタック（MVP）

### 2.1 アプリ/実行基盤

- 言語: Python 3.12
- 実行: Cloud Functions for Firebase (2nd gen)
- 理由:
  - スケジュール実行（決算通知、日次計算）を `onSchedule` で実装しやすい
  - サーバ管理不要で、MVPに必要なジョブ実行を早く作れる

### 2.2 データ/状態管理

- DB: Cloud Firestore
- 保存対象:
  - ウォッチリスト
  - 日次指標
  - 判定状態（streak含む）
  - 通知ログ
- 理由:
  - Firebaseとの統合が強く、初期実装を短期間で進めやすい

### 2.3 スケジューラ

- Cloud Scheduler（Firebase Functionsの `onSchedule` 経由）
- ジョブ:
  - 日次計算ジョブ
  - 土曜21:00「来週決算」通知
  - 毎日21:00「明日決算」通知
- タイムゾーン: JST固定

### 2.4 通知

- 第一優先: Discord（Webhook）
- 第二優先: LINE Messaging API（Discord完成後）
- 理由:
  - MVPの最短到達を優先し、先にDiscordで通知経路を確立する

### 2.5 秘匿情報/設定

- Secret Manager:
  - Discord Webhook URL
  - LINEチャネルシークレット/トークン
  - データソース認証情報
- `.env` はローカル開発のみ利用し、本番はSecret Managerを正本とする

### 2.6 監視/運用

- Cloud Logging: 関数実行ログ・通知結果ログ
- Cloud Monitoring: 失敗回数、エラー率、ログベースアラート

## 3. AI（第2段階）

- モデル: Vertex AI 上の Anthropic Claude
- 用途:
  - IR/SNS要約
  - 根拠URL・分類ラベル付きのAI注目通知
- 備考:
  - MVPでは必須外。まずはPER/PSR通知と決算通知を先に完成させる

## 4. 最小アーキテクチャ

1. Cloud Scheduler が定期トリガー
2. Cloud Functions がデータ取得・計算・判定
3. Firestore に状態保存（指標、判定、通知ログ）
4. Discordへ通知送信
5. 失敗時は Logging/Monitoring で検知

## 5. 実装順（この定義に基づく）

1. Issue 01: 初期構成・設定管理
2. Issue 02: Firestoreスキーマ/永続化層
3. Issue 03-11: 計算・判定・メッセージ整形
4. Issue 12: Discordボット/通知
5. Issue 14-15: 決算通知ジョブ
6. Issue 16-19: 欠損通知・ログ・テスト
7. Issue 13: LINE通知

