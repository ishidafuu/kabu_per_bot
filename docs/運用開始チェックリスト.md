# 運用開始チェックリスト（BOT + Web）

## 0. このドキュメントの使い方

- 目的:
  - 次セッションで、手順どおりに環境構築・起動確認・疎通確認を完了する
- 対象:
  - BOT運用（Discord通知を含む）
  - Web運用（FastAPI + React）
- 前提:
  - リポジトリは `main` 最新を使用する
  - 個人運用（branch protection なし）

## 1. 現在の実装範囲（着手前に確認）

### 1.1 利用可能

1. FastAPI Web API（`/api/v1/healthz`, `/api/v1/watchlist*`）
2. React管理画面（W06〜W12）
3. BOTコア（履歴、指標計算ロジック、通知整形、Discord通知パイプライン）
4. Firestore初期マイグレーション（`0001_initial`）

### 1.2 実装状況/注意点

1. 市場データ本番取得（四季報/株探/Yahoo）は実装済み。運用前に各データソース接続と欠損時ログ出力を確認する
2. BOTの日次ジョブはローカルデモ実行スクリプト中心
3. WebはW12（E2E/デプロイ手順）が残タスク。主要導線の再現実行性を優先して整備する

## 2. 事前準備（アカウント・ツール）

## 2.1 必須アカウント

1. GitHub
2. Google Cloud（Firestore利用）
3. Firebase（Auth/Web設定）
4. Discord（Webhook作成）

## 2.2 ローカルツール

1. Python 3.12+
2. Node.js 20+ / npm
3. Git

## 2.3 実行確認コマンド

```bash
python3 --version
node --version
npm --version
git --version
```

## 2.3.1 W12 デプロイ事前チェック（Hosting + Cloud Run）

外部接続前に、デプロイ準備が完了しているかをローカルで確認する。

### A. 必須環境変数

1. ルート `.env`
2. `FIRESTORE_PROJECT_ID`
3. `DISCORD_WEBHOOK_URL`
4. `web/.env.local`
5. `VITE_API_BASE_URL`
6. `VITE_USE_MOCK_API`（ステージング反映時は `false` を想定）
7. `VITE_USE_MOCK_AUTH`（ステージング反映時は `false` を想定）
8. `VITE_USE_MOCK_AUTH=false` の場合は Firebase設定値も必須
9. `VITE_FIREBASE_API_KEY`
10. `VITE_FIREBASE_AUTH_DOMAIN`
11. `VITE_FIREBASE_PROJECT_ID`
12. `VITE_FIREBASE_APP_ID`

### B. 必須CLI

1. `python`（未導入の場合は `python3`）
2. `node`
3. `npm`
4. `git`
5. `firebase`（Hostingデプロイで使用）
6. `gcloud`（Cloud Runデプロイで使用）

```bash
python --version || python3 --version
node --version
npm --version
git --version
firebase --version
gcloud --version
```

### C. 機械チェック（デプロイ実行なし）

```bash
cd /Users/ishidafuu/Documents/repository/kabu_per_bot-docs-finalize
bash scripts/preflight_deploy_check.sh
```

期待結果:

1. 終了コード `0`（CLI不足や`web`ビルド失敗時は `1`）
2. `Summary: failures=0` が表示される
3. `WARN` が出た場合は環境変数を埋めて再実行する

## 2.4 `FIRESTORE_PROJECT_ID` / `DISCORD_WEBHOOK_URL` の外部サイト準備

## 2.4.1 `FIRESTORE_PROJECT_ID`（Google Cloud）

外部サイト:

1. Google Cloud Console: https://console.cloud.google.com/
2. Firebase Console（必要に応じて）: https://console.firebase.google.com/

準備手順:

1. Google Cloudで利用するプロジェクトを作成または選択する
2. Firestoreを有効化する（Native mode）
3. プロジェクトIDを控える（例: `my-stock-bot-prod`）
4. `.env` の `FIRESTORE_PROJECT_ID` に設定する

ローカル実行に必要な認証（ADC）:

1. Google Cloud SDK（`gcloud`）をインストール済みであることを確認
2. `gcloud auth application-default login` を実行
3. 必要に応じて `gcloud config set project <FIRESTORE_PROJECT_ID>` を実行

確認コマンド:

```bash
gcloud auth application-default print-access-token
```

トークン文字列が返れば、ADC設定は概ね完了。

## 2.4.2 `DISCORD_WEBHOOK_URL`（Discord）

外部サイト:

1. Discord（ブラウザまたはデスクトップアプリ）: https://discord.com/

準備手順:

1. 通知を送るDiscordサーバーとチャンネルを用意する
2. 対象チャンネルの `チャンネル設定` -> `連携サービス` -> `ウェブフック` を開く
3. `新しいウェブフック` を作成し、送信先チャンネルを指定する
4. Webhook URLをコピーして `.env` の `DISCORD_WEBHOOK_URL` に設定する

疎通確認:

```bash
source .venv/bin/activate
PYTHONPATH=src python scripts/send_discord_test_notification.py --webhook-url <DISCORD_WEBHOOK_URL>
```

`Discord test notification sent.` が表示され、チャンネルに通知が届けばOK。

## 2.4.3 セキュリティ注意

1. `DISCORD_WEBHOOK_URL` はシークレットとして扱う（公開リポジトリに載せない）
2. 誤って漏えいした場合はDiscord側でWebhookを再発行する
3. `.env` と `web/.env.local` がgit管理外であることを `git status` で確認する

## 3. リポジトリ同期

```bash
cd /Users/ishidafuu/Documents/repository/kabu_per_bot
git pull origin main
git status
```

チェック:

1. `git status` がクリーンである

## 4. 環境変数ファイル作成

## 4.1 ルート（Python/BOT/API）

```bash
cp .env.example .env
```

`.env` で最低限設定する値:

1. `FIRESTORE_PROJECT_ID=<GCPプロジェクトID>`
2. `DISCORD_WEBHOOK_URL=<Discord Webhook URL>`
3. 値の取得手順は「2.4 `FIRESTORE_PROJECT_ID` / `DISCORD_WEBHOOK_URL` の外部サイト準備」を参照

## 4.2 Web（React）

```bash
cp web/.env.example web/.env.local
```

まずはローカル検証を優先するため、初期値は以下を推奨:

1. `VITE_USE_MOCK_API=true`
2. `VITE_USE_MOCK_AUTH=true`

実API/実Auth接続へ進む場合は、後段の「8. 実API接続」実施時に更新する。

## 5. Python環境セットアップ（BOT + API）

```bash
python3 -m venv .venv
source .venv/bin/activate
pip install -e .
pip install -e ".[gcp]"
```

チェック:

1. 依存インストールがエラーなく完了する

## 6. Firestoreマイグレーション

```bash
source .venv/bin/activate
PYTHONPATH=src python scripts/migrate_firestore_v0001.py --project-id <GCP_PROJECT_ID>
```

期待結果:

1. 初回: `Applied Firestore migration 0001_initial`
2. 2回目: `Firestore migration 0001_initial was already applied`

失敗時確認:

1. `FIRESTORE_PROJECT_ID` の誤り
2. GCP認証（ADC）未設定
3. `google-cloud-firestore` 未インストール

## 7. バックエンドAPI起動と確認

## 7.1 起動

```bash
source .venv/bin/activate
uvicorn kabu_per_bot.api.app:app --reload
```

## 7.2 ヘルスチェック

```bash
curl -s http://127.0.0.1:8000/api/v1/healthz
```

期待結果:

1. `{"status":"ok"}`

## 7.3 認証が有効か確認

```bash
curl -i http://127.0.0.1:8000/api/v1/watchlist
```

期待結果:

1. `401 Unauthorized`（保護されていることを確認）

## 8. Web起動と確認

## 8.1 起動

```bash
cd /Users/ishidafuu/Documents/repository/kabu_per_bot/web
npm install
npm run dev
```

ブラウザ:

1. `http://localhost:5173`

## 8.2 モード別確認

### A. モックモード（先に実施）

- 条件:
  - `VITE_USE_MOCK_API=true`
  - `VITE_USE_MOCK_AUTH=true`
- 確認項目:
  1. ログイン画面表示
  2. モックログイン可能
  3. ウォッチリスト一覧/追加/編集/削除のUI動作

### B. 実API + 実Authモード（次段階）

- `web/.env.local` 変更:
  1. `VITE_USE_MOCK_API=false`
  2. `VITE_USE_MOCK_AUTH=false`
  3. `VITE_API_BASE_URL=http://localhost:8000/api/v1`
  4. Firebase設定値（API_KEY等）入力
- 追加前提:
  1. Firebase Auth有効化
  2. API側でFirebase IDトークン検証が通る状態（`firebase-admin`）

## 8.3 Web E2Eの実行（W12）

```bash
cd /Users/ishidafuu/Documents/repository/kabu_per_bot/web
npm run test:e2e
E2E_API_PYTHON=../.venv/bin/python npm run test:e2e:api
```

詳細手順は以下を参照:

- `docs/Web_E2Eテストとステージング反映手順.md`

## 9. BOTローカル運用確認

## 9.1 テスト実行

```bash
cd /Users/ishidafuu/Documents/repository/kabu_per_bot
source .venv/bin/activate
PYTHONPATH=src python -m unittest discover -s tests
```

期待結果:

1. 全テストが `OK`

## 9.2 Discord疎通テスト

```bash
PYTHONPATH=src python scripts/send_discord_test_notification.py --webhook-url <DISCORD_WEBHOOK_URL>
```

期待結果:

1. Discordにテスト通知が届く
2. コンソールに `Discord test notification sent.`

## 9.3 日次パイプライン（Firestore本番実行）

```bash
PYTHONPATH=src python scripts/run_daily_job.py --discord-webhook-url <DISCORD_WEBHOOK_URL>
```

期待結果:

1. パイプライン実行結果JSONが出力される
2. Discord通知送信が行われる
3. Firestore `notification_log` に通知ログが保存される

## 10. 運用開始前の最終チェック（Go/No-Go）

以下がすべて `YES` なら運用開始可。

1. `bash scripts/preflight_deploy_check.sh` が `0` で完了
2. Firestoreマイグレーションが適用済み
3. APIヘルスチェックが成功
4. Web（モックモード）が問題なく操作可能
5. Web E2E（モックUI + API結合）が成功
6. Discord疎通テスト成功
7. テストスイート全件成功
8. `.env`, `web/.env.local` に秘匿情報漏れがない（git管理外）

## 11. 日次運用ルーチン（当面）

1. API起動状態確認（必要時）
2. Discord webhook有効確認
3. BOT日次ジョブ実行（またはスケジューラ実行確認）
4. 通知ログと失敗ログの確認
5. 異常時は再実行し、再現条件をメモ

## 12. 障害対応クイックガイド

### 12.1 `401 Unauthorized` が続く

1. Webがモック認証か実認証か確認
2. AuthorizationヘッダがBearer形式か確認
3. Firebaseトークンの有効期限切れを確認

### 12.2 Firestore接続エラー

1. `FIRESTORE_PROJECT_ID` を確認
2. GCP認証情報（ADC）の設定を確認
3. マイグレーション適用状態を確認

### 12.3 Discord通知が飛ばない

1. `DISCORD_WEBHOOK_URL` を確認
2. `scripts/send_discord_test_notification.py` で単体疎通確認
3. レート制限/ネットワークエラーのログ確認

## 13. 次セッションでの推奨実施順

1. セクション 3〜6 を実施（基盤準備）
2. セクション 7〜8A を実施（API/Webローカル確認）
3. セクション 9 を実施（BOT疎通）
4. セクション 10 の Go/No-Go 判定
5. 必要なら 8B（実Auth/実API）へ進む
