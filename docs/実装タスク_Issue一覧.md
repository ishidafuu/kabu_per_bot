# 株式監視BOT 実装タスク（Issue粒度）

## 0. 運用ルール

- 対象はMVP範囲のみ（IR/SNS/AI注目は別マイルストーン）
- 各Issueは「受け入れ基準を満たしたらDone」
- 依存Issueがあるものは、先行Issue完了後に着手する

## 1. マイルストーン

1. M1: 基盤・データモデル・ウォッチリスト
2. M2: PER/PSR計算・シグナル判定
3. M3: 通知（クールダウン、Discord先行、決算）
4. M4: 欠損通知・ログ・E2E検証

## 2. Issue一覧（起票用）

### Issue 01: プロジェクト初期構成と設定管理を作る

- 目的: 実装の土台を揃える
- スコープ:
  - `src/`, `tests/`, `docs/` の基本構成
  - 設定ファイル読み込み（JST固定、期間N、クールダウン2h）
  - `.env.example` 作成
- 受け入れ基準:
  - アプリ起動時に設定値を読み込める
  - 未設定時はデフォルト値（5/63/252, 2h, JST）が使われる
- 依存: なし

### Issue 02: DBスキーマとマイグレーションを実装する

- 目的: MVP要件の永続化を成立させる
- スコープ:
  - Firestoreコレクション定義（`watchlist`, `watchlist_history`, `daily_metrics`, `metric_medians`, `signal_state`, `earnings_calendar`, `notification_log`）
  - インデックス定義と一意制約（ドキュメントIDの合成キー）
  - 初期マイグレーション（`0001_initial`）実行スクリプト
- 受け入れ基準:
  - マイグレーション1回で初期スキーマ登録が完了する
  - 同一マイグレーションの二重適用が防止される
  - 重複登録防止のためのドキュメントID規約が定義されている
- 依存: Issue 01

### Issue 03: ウォッチリストCRUD（最大100銘柄）を実装する

- 目的: 監視対象の登録・更新・削除を可能にする
- スコープ:
  - 追加/一覧/更新/削除
  - 100件上限チェック
  - `metric_type(PER|PSR)`、通知先、通知時間の保存
- 受け入れ基準:
  - 101件目追加でエラーを返す
  - 更新後に再取得すると設定値が反映されている
- 依存: Issue 02

### Issue 04: ウォッチリスト操作履歴を実装する

- 目的: 追加/削除の監査可能性を確保する
- スコープ:
  - ADD/REMOVE時に `watchlist_history` へ記録
  - 理由メモ保存（任意入力）
- 受け入れ基準:
  - 追加/削除操作で履歴が必ず1件作成される
  - 理由メモが保存・参照できる
- 依存: Issue 03

### Issue 05: 市場データ取得インターフェースを実装する

- 目的: データソース交換可能な取得層を作る
- スコープ:
  - 取得IF定義（終値、EPS今期、売上今期、決算日）
  - 優先順制御（四季報online → 株探 → Yahoo!ファイナンス）
  - 取得失敗時のエラー型定義
- 受け入れ基準:
  - ソース切替が呼び出し側に透過である
  - 全ソース失敗時に欠損理由を返せる
- 依存: Issue 01

### Issue 06: 日次指標計算（PER/PSR）を実装する

- 目的: 監視指標を日次で計算・保存する
- スコープ:
  - `PER = close / eps_forecast`
  - PSR監視銘柄はPSR計算
  - PER未定義時は「欠損扱い」
- 受け入れ基準:
  - 日次実行で `daily_metrics` に保存される
  - EPS欠損/0以下時はPER未定義で保存される
- 依存: Issue 02, Issue 05

### Issue 07: 中央値計算（1W/3M/1Y）を実装する

- 目的: 比較基準となる中央値を算出する
- スコープ:
  - 営業日系列から 5/63/252 の中央値算出
  - 結果を `metric_medians` に保存
- 受け入れ基準:
  - 任意銘柄の指定日で3つの中央値が取得できる
  - データ不足時は不足状態を返せる
- 依存: Issue 06

### Issue 08: under判定とコンボ判定ロジックを実装する

- 目的: 通知シグナルを決定する
- スコープ:
  - `under_1y`, `under_3m`, `under_1w` 判定
  - 通常3コンボ（1Y+3M, 3M+1W, 1Y+1W）
  - 強通知（3条件すべて）
- 受け入れ基準:
  - 与えた入力に対し期待コンボを返す
  - 強通知条件が通常より優先される
- 依存: Issue 07

### Issue 09: 連続日数（streak）管理を実装する

- 目的: 「n日連続」を正しく表示する
- スコープ:
  - 同一銘柄・同一通知種別・同一コンボで継続判定
  - 外れたらリセット
  - `signal_state` 保存
- 受け入れ基準:
  - 継続時は+1、非継続時は1に戻る
  - 強通知と通常通知で別カウントできる
- 依存: Issue 08

### Issue 10: 通知重複抑制（2時間クールダウン）を実装する

- 目的: スパム通知を防ぐ
- スコープ:
  - 同一銘柄・同一カテゴリ・同一条件で2h抑制
  - 通常→強遷移は即時通知を許可
- 受け入れ基準:
  - 2h以内の同一条件通知は送信されない
  - 強遷移時は2h以内でも送信される
- 依存: Issue 09

### Issue 11: 通知メッセージ整形を実装する

- 目的: 要件どおりの通知文面を出力する
- スコープ:
  - `PER割安/超PER割安/PSR割安/超PSR割安`
  - `今週決算/明日決算`
  - `データ不明`
- 受け入れ基準:
  - フォーマットが要件書記載パターンと一致する
  - 連続日数が正しく付与される
- 依存: Issue 08, Issue 09

### Issue 12: Discordボット/通知アダプタを実装する

- 目的: Discordへ通知を配信する
- スコープ:
  - WebhookまたはBot送信処理
  - エラーハンドリングと再試行（最小限）
- 受け入れ基準:
  - 疑似通知でDiscordに投稿される
  - 失敗時ログに理由が残る
- 依存: Issue 11

### Issue 13: LINE通知アダプタを実装する

- 目的: LINE Messaging APIで通知を配信する
- スコープ:
  - チャネル設定読み込み
  - Push送信処理
  - エラーハンドリング
- 受け入れ基準:
  - 疑似通知でLINEへ送信される
  - API失敗時にエラーログが残る
- 依存: Issue 12

### Issue 14: 決算カレンダー取得と保存を実装する

- 目的: 決算通知の元データを管理する
- スコープ:
  - 決算日（可能なら時刻・四半期）取得
  - `earnings_calendar` へ保存/更新
- 受け入れ基準:
  - 取得結果が銘柄単位で更新される
  - 日付のみ取得時でも保存可能
- 依存: Issue 02, Issue 05

### Issue 15: 決算通知ジョブ（土曜21時/毎日21時）を実装する

- 目的: 定時の決算通知を自動化する
- スコープ:
  - 土曜21時: 来週決算通知
  - 毎日21時: 明日決算通知
  - JST基準スケジュール
- 受け入れ基準:
  - スケジュール時刻に対象銘柄のみ通知される
  - 通知カテゴリが要件どおりになる
- 依存: Issue 14, Issue 12

### Issue 16: 欠損通知（データ不明）を実装する

- 目的: サイレント失敗を防止する
- スコープ:
  - EPS欠損/売上欠損/決算日時欠損の分類
  - `【データ不明】` 通知生成
- 受け入れ基準:
  - 欠損種別が通知本文に表示される
  - 欠損時でも処理全体が停止しない
- 依存: Issue 06, Issue 14

### Issue 17: 通知ログと追跡機能を実装する

- 目的: 「いつ何を送ったか」を追跡可能にする
- スコープ:
  - `notification_log` 保存
  - 条件キー/チャネル/送信時刻を記録
- 受け入れ基準:
  - 任意銘柄の通知履歴を時系列で取得できる
  - クールダウン判定がログを参照して動作する
- 依存: Issue 10, Issue 12

### Issue 18: バッチ/ジョブ統合フロー（E2E）を実装する

- 目的: 日次運用を一連で実行可能にする
- スコープ:
  - 日次: 取得→計算→判定→通知
  - 定時: 決算通知ジョブ
  - 失敗時の継続処理
- 受け入れ基準:
  - 1コマンドで日次フロー実行できる
  - 部分失敗時も他銘柄処理を継続できる
- 依存: Issue 06〜17

### Issue 19: テスト整備（単体/結合）を実装する

- 目的: ロジック回帰を防ぐ
- スコープ:
  - under判定、強通知、クールダウン、streak
  - 通知フォーマット
  - 欠損通知
- 受け入れ基準:
  - 主要ロジックに自動テストがある
  - CIまたはローカルで再現可能に実行できる
- 依存: Issue 08〜18

### Issue 20: 運用ドキュメントを整備する

- 目的: ローカル運用と障害対応を標準化する
- スコープ:
  - セットアップ手順
  - 定期実行方法
  - よくある障害（データ欠損/API失敗）対応
- 受け入れ基準:
  - 新規環境で手順どおりに起動できる
  - 障害時の確認ポイントが明文化される
- 依存: Issue 18, Issue 19

## 3. 起票テンプレート（コピペ用）

```md
## 概要

## 背景/目的

## スコープ
- 

## 受け入れ基準
- [ ] 

## 実装メモ
- 

## 依存Issue
- #
```

## 4. 第2段階バックログ（SNS/AI）

### 候補Issue A: X API収集 + Gemini要約の初期実装

- 目的: SNS監視の標準経路を実装する
- スコープ:
  - X APIで投稿収集
  - Geminiで要約/分類
  - 根拠URL付き通知文生成

### 候補Issue B: Grok比較PoC（条件付き）

- 起票条件:
  - X API + Geminiで必要品質を満たせないことが計測で確認された場合
- 比較観点:
  - 再現率
  - 速報性
  - 追加コスト

## 5. Web管理画面タスク

Web管理画面のIssue一覧は以下を参照する。

- `/Users/ishidafuu/Documents/repository/kabu_per_bot/docs/Web実装タスク_Issue一覧.md`
